---
description: change data capture 侵入性/非侵入性
---

# 数据库CDC

数据库在本质上是一个状态集合，任何对数据库的变更（增删改）本质上都是对状态的修改。

在实际生产中，我们经常需要把数据库的状态同步到其他地方去，例如同步到数据仓库进行分析，同步到消息队列供下游消费，同步到缓存以加速查询。总的来说，搬运状态有两大类方法：ETL与CDC。

ETL（Extract Transform Load）着眼于状态本身，用定时批量轮询的方式拉取状态本身。

CDC（Changing Data Capture）则着眼于变更事件，以流式的方式持续收集状态变化事件（变更）。

因此实施CDC，数据库至少需要提供以下功能：

1. 获取数据库的变更日志（WAL），并解码成逻辑上的事件（对表的增删改而不是数据库的内部表示）
2. 获取数据库的"一致性快照"，从而订阅者可以从任意一个一致性状态开始订阅而不是数据库创建伊始。
3. 保存消费者偏移量，以便跟踪订阅者的消费进度，及时清理回收不用的变更日志以免撑爆磁盘。

### **基于时间戳的CDC**

抽取过程可以根据某些属性列来判断哪些数据是增量的，最常见的属性列有以下两种：

* 时间戳：最好有两个列，一个插入时间戳，表示何时创建，一个更新时间戳，表示最后一次更新的时间。
* 序列：大多数数据库都提供自增功能，如果数据库表列被定义成自增的，就可以很容易地根据该列识别新插入的数据。

这种方法是最简单且常用的，但是有如下缺点：

* 不能记录删除记录的操作
* 无法识别多次更新
* 不具有实时能力

### **基于触发器的CDC**

当执行INSERT、UPDATE、DELETE这些SQL语句时，可以激活数据库里的触发器，并执行一些动作，就是说触发器可以用来捕获变更的数据并把数据保存在中间临时表里。然后这些变更数据再从临时表取出，抽取到数据仓库的过渡区中。大多数场合下，不允许向操作型数据库里添加触发器，且这种方法会降低系统性能，所以用的不多。\
可以使用源数据库的复制功能，将源库的数据备用到备用库上，在备库上创建触发器。\
有关于这种方法，我们将结合HANA数据库在下面进行详细阐述和举例。

### **基于快照的CDC**

如果没有时间戳，不允许使用触发器，就要使用快照表。可以通过比较源表和快照表来获得数据变化。\
基于快照的CDC可以检测到插入、更新和删除的数据，这是相对于基于时间戳的CDC方案的有点。其缺点是需要大量存储空间来保存快照。

### **基于日志的CDC**

最复杂的和没有侵入性的CDC方法是基于日志的方式。数据库会把每个插入、更新、删除操作记录到日志里。

\
\
